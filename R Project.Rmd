---
title: "R Project"
output: html_document
date: "2022-11-25"
author: 'Daniel Setiawan'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(tidyr)
library(ggplot2)
library(lubridate)
library(tidyverse)
```

*Data* <http://insideairbnb.com/get-the-data> column name dictionary: <https://docs.google.com/spreadsheets/d/1b_dvmyhb_kAJhUmv81rAxl4KcXn0Pymz>

```{r}
# detect all files
filename = list.files(pattern = '*.csv', full.names = TRUE)
```


```{r}
## add city and state columns to all dataframes
# cities = gsub('\\./|\\.csv', '', filename)
# names(cities) = c('NC', 'TX', 'MA', 'FL', 'MA', 'IL', 'NV', 'OH', 'TX', 
#                 'CO', 'TX', 'HI', 'NJ', 'CA', 'CA', 'TN', 'AK', 'NJ', 
#                 'NY', 'CA', 'CA', 'OR', 'RI', 'MA', 'CA', 'CA', 'CA', 
#                 'CA', 'CA', 'WA', 'MN', 'DC')
# 
# for (file in filename) {
#   city = gsub('\\./|2?\\.csv', '', file)
#   state = names(cities)[cities == city]
#   df = read_csv(file, show_col_types = FALSE)
#   df %>%
#     mutate(city = city,
#            state = state) %>%
#     write_csv(file)
# }
```

```{r}
# combine all cities into one dataframe
# due to null values, its easier to convert all columns as type c
df_raw = filename %>%
  lapply(read_csv, col_types = cols(.default = 'c')) %>%
  bind_rows
```


*Cleaning up the data*

```{r}
# removing columns we don't need
df = df_raw %>%
  select(-c(2:3, 9, 15:16, 23, 27, 35:38, 41:45, 47, 49:51, 61:64, 68:77))

#removing na from selected columns
df = df %>%
  drop_na(c(description, host_since, bedrooms, beds, bathrooms_text))

#making df readable and easy to analyze
df = df %>%
  mutate(across(c(price, host_acceptance_rate, host_response_rate, 
                  host_response_time), ~ gsub(',|\\$|%|N/A', '', .)),
         bathrooms = ifelse(grepl('half-bath', bathrooms_text), 
                            0.5, gsub('[^0-9.]', '',bathrooms_text)),
         across(c(review_scores_rating, review_scores_accuracy, 
              review_scores_cleanliness, review_scores_checkin, 
              review_scores_communication, review_scores_location,
              review_scores_value, reviews_per_month, accommodates,
              bedrooms, beds, minimum_nights, maximum_nights, 
              minimum_nights_avg_ntm, maximum_nights_avg_ntm, price,
              number_of_reviews, host_total_listings_count, bathrooms,
              price, host_acceptance_rate, host_response_rate,
              availability_365), as.numeric),
         across(c(description, host_about), ~ str_count(., '\\s+') + 1),
         across(c(host_since, last_review), ~ as.Date(., '%m/%d/%y')),
         title_len = str_length(name),
         num_hosts = str_count(host_name, 'and|And|\\&') + 1,
         amenities_count = str_count(amenities, '"') / 2,
         num_verification = str_count(host_verifications, "'") / 2,
         bathrooms_text = ifelse(grepl('hared', bathrooms_text), 
                                 'shared', 'private'),
         across(c(host_response_time, bathrooms_text, property_type,
                  room_type), factor),
         across(c(instant_bookable, host_has_profile_pic, 
                  host_identity_verified, host_is_superhost), as.logical))

# removing additional null values
df = df %>%
  filter(!price == 0)

# and outliers
var_ = df$price

quartiles = quantile(var_, probs=c(0.25, 0.75))
iqr = IQR(var_)

lower = quartiles[1] - 1.5 * iqr
upper = quartiles[2] + 1.5 * iqr

df = subset(df, var_ > lower & var_ < upper)
```

```{r}
summary(df)
```




```{r}
df %>%
  # group_by(state) %>%
  # mutate(price2 = mean(price)) %>%
  # ungroup(state) %>%
  ggplot(aes(price, reorder(state, price))) +
  geom_boxplot(aes(color = state), show.legend = FALSE) +
  labs(title = 'Average Cost by State',
       x = 'Price per night (USD)',
       y = 'State', 
       color = FALSE)
  ggsave('AirBNB Cost by State - Boxplot.png', width = 10, height = 6)
```

```{r pressure, echo=FALSE}
df %>%
  group_by(state) %>%
  summarise(price = mean(price)) %>%
  ggplot(aes(price, reorder(state, price))) +
  geom_col(aes(color = state), show.legend = FALSE) +
  # facet_grid(. ~ room_type, scales = 'free_x') +
  labs(title = 'Average Cost by State',
       x = 'Price per night (USD)',
       y = 'State')
  ggsave('AirBNB Cost by State - Barplot.png', width = 10, height = 6)
```

```{r}
df %>%
  filter(number_of_reviews < 2000) %>%
  ggplot(aes(price, number_of_reviews)) +
  geom_col(aes(color = room_type)) +
  facet_wrap(. ~ room_type, scales = 'free') +
  labs(title = 'Room Cost vs. Reviews',
       color = 'Room Type',
       x = 'Price per night (USD)',
       y = 'Number of Reviews')
  ggsave('Room Cost by Reviews.png', width = 10, height = 6)
```

```{r}
lubridate::year(df$host_since)
```


```{r}
df %>%
  group_by(city) %>%
  summarise(count = sum(number_of_reviews)) %>%
  arrange(desc(count)) %>%
  ggplot(aes(count, reorder(city, count))) +
  geom_col(aes(fill = 'FC642D'), show.legend = FALSE) + 
  theme_few() +
  labs(title = 'Review Count by City',
       x = 'Number of Reviews',
       y = 'City') +
  scale_x_continuous(breaks = c(0, 5e5, 1e6), labels = c('0', '500K', '1M'))
  ggsave('Reviews by City - Barplot.png', width = 10, height = 6)
```
```{r}
df %>%
  group_by(city) %>%
  summarise(count = sum(number_of_reviews)) %>%
  arrange(desc(count)) %>%
  ggplot(aes(count, reorder(city, count))) +
  geom_col(aes(fill = 'FC642D'), show.legend = FALSE) + 
  theme_few() +
  labs(title = 'Review Count by City',
       x = 'Number of Reviews',
       y = 'City')
  # scale_x_continuous(breaks = c(0, 5e5, 1e6), labels = c('0', '500K', '1M'))
  ggsave('Reviews by City - Barplot.png', width = 10, height = 6)
```
```{r}
days(df$last_review)
df
```

```{r}
library(tidyr)
tidyr::unnest(df, cols = c('amenities'), names_sep = ',') %>%
  
```
```{r}
df2 = df %>%
  mutate(amenities = tolower(gsub('\\]|\\[|"', '', amenities))) %>%
  tidyr::separate_rows(amenities, sep = ', ') %>%
  mutate(amenities = case_when(grepl('coffee', amenities) ~ 'coffee', 
                               grepl('long term', amenities) ~ 'long term',
                               grepl('parking|garage|carport', amenities) ~ 'parking',
                               grepl('shampoo|condition|essential|soap', amenities) ~ 'toiletries',
                               grepl('tv|netflix|hulu|streaming|cable|roku|hbo|prime video|dvd', amenities) ~ 'tv',
                               grepl('washer|dryer|laundry', amenities) ~ 'laundry',
                               grepl('patio|balcony', amenities) ~ 'outdoor space',
                               grepl('hot tub|pool|jacuzzi|sauna', amenities) ~ 'outdoor tub',
                               grepl('staff', amenities) ~ 'concierge',
                               grepl('ev', amenities) ~ 'ev charging',
                               grepl('gym', amenities) ~ 'gym',
                               grepl('wifi', amenities) ~ 'wifi',
                               grepl('ac|a/c', amenities) ~ 'ac',
                               grepl('heat', amenities) ~ 'heater',
                               grepl('sound|music|stereo|bluetooth|aux', amenities) ~ 'music',
                               grepl('game|ping pong|billiard', amenities) ~ 'gameroom',
                               grepl('fridge|refrigerator|freezer|toaster', amenities) ~ 'kitchen',
                               grepl('oven|dishes|cooking|microwave|stove', amenities) ~ 'kitchen',
                               grepl('camera', amenities) ~ 'security camera',
                               grepl('alarm|fire|smoke|extinguisher|first aid', amenities) ~ 'safety',
                               grepl('pillows|blankets|linens', amenities) ~ 'linens',
                               TRUE ~ amenities)) %>%
  distinct()

df2 %>%
  group_by(amenities) %>%
  summarise(count = n()) %>%
  arrange(desc(count)) %>%
  head(25) %>%
  ggplot(aes(count, reorder(amenities, count))) + 
    geom_col(aes(fill = 'FC642D'), show.legend = FALSE) +
    theme_few() +
    labs(title = 'Amenities Offered by Hosts',
       x = 'Count',
       y = 'Amenities')
```





```{r}
df %>%
  filter(grepl('ishwasher', amenities))
```


```{r}
df %>%
  na.omit(host_is_superhost) %>%
  ggplot(aes(year(host_since), number_of_reviews)) +
  geom_point(aes(color = host_is_superhost)) +
  facet_grid(. ~ host_is_superhost)
  
```
```{r}
df %>%
  group_by(property_type) %>%
  summarise(count = n()) %>%
  arrange(desc(count)) %>%
  head(10) %>%


  ggplot(aes(count, reorder(property_type, count))) +
  geom_col()

```

